begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|pdfwriter
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|OutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|security
operator|.
name|MessageDigest
import|;
end_import

begin_import
import|import
name|java
operator|.
name|security
operator|.
name|NoSuchAlgorithmException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|text
operator|.
name|DecimalFormat
import|;
end_import

begin_import
import|import
name|java
operator|.
name|text
operator|.
name|NumberFormat
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Hashtable
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Locale
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|COSArray
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|COSBase
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|COSBoolean
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|COSDictionary
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|COSDocument
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|COSFloat
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|COSInteger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|COSName
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|COSNull
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|COSObject
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|COSStream
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|COSString
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|ICOSVisitor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|exceptions
operator|.
name|COSVisitorException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|exceptions
operator|.
name|CryptographyException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|pdmodel
operator|.
name|PDDocument
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|pdmodel
operator|.
name|encryption
operator|.
name|SecurityHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|persistence
operator|.
name|util
operator|.
name|COSObjectKey
import|;
end_import

begin_comment
comment|/**  * this class acts on a in-memory representation of a pdf document.  *  * todo no support for incremental updates  * todo single xref section only  * todo no linearization  *  * @author Michael Traut  * @author<a href="mailto:ben@benlitchfield.com">Ben Litchfield</a>  * @version $Revision: 1.36 $  */
end_comment

begin_class
specifier|public
class|class
name|COSWriter
implements|implements
name|ICOSVisitor
block|{
comment|/**      * The dictionary open token.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|DICT_OPEN
init|=
literal|"<<"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
comment|/**      * The dictionary close token.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|DICT_CLOSE
init|=
literal|">>"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
comment|/**      * space character.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|SPACE
init|=
literal|" "
operator|.
name|getBytes
argument_list|()
decl_stmt|;
comment|/**      * The start to a PDF comment.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|COMMENT
init|=
literal|"%"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
comment|/**      * The output version of the PDF.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|VERSION
init|=
literal|"PDF-1.4"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
comment|/**      * Garbage bytes used to create the PDF header.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|GARBAGE
init|=
operator|new
name|byte
index|[]
block|{
operator|(
name|byte
operator|)
literal|0xf6
block|,
operator|(
name|byte
operator|)
literal|0xe4
block|,
operator|(
name|byte
operator|)
literal|0xfc
block|,
operator|(
name|byte
operator|)
literal|0xdf
block|}
decl_stmt|;
comment|/**      * The EOF constant.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|EOF
init|=
literal|"%%EOF"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
comment|// pdf tokens
comment|/**      * The reference token.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|REFERENCE
init|=
literal|"R"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
comment|/**      * The XREF token.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|XREF
init|=
literal|"xref"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
comment|/**      * The xref free token.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|XREF_FREE
init|=
literal|"f"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
comment|/**      * The xref used token.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|XREF_USED
init|=
literal|"n"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
comment|/**      * The trailer token.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|TRAILER
init|=
literal|"trailer"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
comment|/**      * The start xref token.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|STARTXREF
init|=
literal|"startxref"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
comment|/**      * The starting object token.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|OBJ
init|=
literal|"obj"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
comment|/**      * The end object token.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|ENDOBJ
init|=
literal|"endobj"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
comment|/**      * The array open token.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|ARRAY_OPEN
init|=
literal|"["
operator|.
name|getBytes
argument_list|()
decl_stmt|;
comment|/**      * The array close token.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|ARRAY_CLOSE
init|=
literal|"]"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
comment|/**      * The open stream token.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|STREAM
init|=
literal|"stream"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
comment|/**      * The close stream token.      */
specifier|public
specifier|static
specifier|final
name|byte
index|[]
name|ENDSTREAM
init|=
literal|"endstream"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
specifier|private
name|NumberFormat
name|formatXrefOffset
init|=
operator|new
name|DecimalFormat
argument_list|(
literal|"0000000000"
argument_list|)
decl_stmt|;
comment|/**      * The decimal format for the xref object generation number data.      */
specifier|private
name|NumberFormat
name|formatXrefGeneration
init|=
operator|new
name|DecimalFormat
argument_list|(
literal|"00000"
argument_list|)
decl_stmt|;
specifier|private
name|NumberFormat
name|formatDecimal
init|=
name|NumberFormat
operator|.
name|getNumberInstance
argument_list|(
name|Locale
operator|.
name|US
argument_list|)
decl_stmt|;
comment|// the stream where we create the pdf output
specifier|private
name|OutputStream
name|output
decl_stmt|;
comment|// the stream used to write standard cos data
specifier|private
name|COSStandardOutputStream
name|standardOutput
decl_stmt|;
comment|// the start position of the x ref section
specifier|private
name|long
name|startxref
init|=
literal|0
decl_stmt|;
comment|// the current object number
specifier|private
name|long
name|number
init|=
literal|0
decl_stmt|;
comment|// maps the object to the keys generated in the writer
comment|// these are used for indirect refrences in other objects
comment|//A hashtable is used on purpose over a hashmap
comment|//so that null entries will not get added.
specifier|private
name|Map
name|objectKeys
init|=
operator|new
name|Hashtable
argument_list|()
decl_stmt|;
comment|// the list of x ref entries to be made so far
specifier|private
name|List
name|xRefEntries
init|=
operator|new
name|ArrayList
argument_list|()
decl_stmt|;
comment|//A list of objects to write.
specifier|private
name|List
name|objectsToWrite
init|=
operator|new
name|ArrayList
argument_list|()
decl_stmt|;
comment|//a list of objects already written
specifier|private
name|Set
name|writtenObjects
init|=
operator|new
name|HashSet
argument_list|()
decl_stmt|;
comment|//An 'actual' is any COSBase that is not a COSObject.
comment|//need to keep a list of the actuals that are added
comment|//as well as the objects because there is a problem
comment|//when adding a COSObject and then later adding
comment|//the actual for that object, so we will track
comment|//actuals separately.
specifier|private
name|Set
name|actualsAdded
init|=
operator|new
name|HashSet
argument_list|()
decl_stmt|;
specifier|private
name|COSObjectKey
name|currentObjectKey
init|=
literal|null
decl_stmt|;
specifier|private
name|PDDocument
name|document
init|=
literal|null
decl_stmt|;
specifier|private
name|boolean
name|willEncrypt
init|=
literal|false
decl_stmt|;
comment|/**      * COSWriter constructor comment.      *      * @param os The wrapped output stream.      */
specifier|public
name|COSWriter
parameter_list|(
name|OutputStream
name|os
parameter_list|)
block|{
name|super
argument_list|()
expr_stmt|;
name|setOutput
argument_list|(
name|os
argument_list|)
expr_stmt|;
name|setStandardOutput
argument_list|(
operator|new
name|COSStandardOutputStream
argument_list|(
name|getOutput
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|formatDecimal
operator|.
name|setMaximumFractionDigits
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|formatDecimal
operator|.
name|setGroupingUsed
argument_list|(
literal|false
argument_list|)
expr_stmt|;
block|}
comment|/**      * add an entry in the x ref table for later dump.      *      * @param entry The new entry to add.      */
specifier|protected
name|void
name|addXRefEntry
parameter_list|(
name|COSWriterXRefEntry
name|entry
parameter_list|)
block|{
name|getXRefEntries
argument_list|()
operator|.
name|add
argument_list|(
name|entry
argument_list|)
expr_stmt|;
block|}
comment|/**      * This will close the stream.      *      * @throws IOException If the underlying stream throws an exception.      */
specifier|public
name|void
name|close
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|getStandardOutput
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|getStandardOutput
argument_list|()
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|getOutput
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|getOutput
argument_list|()
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**      * This will get the current object number.      *      * @return The current object number.      */
specifier|protected
name|long
name|getNumber
parameter_list|()
block|{
return|return
name|number
return|;
block|}
comment|/**      * This will get all available object keys.      *      * @return A map of all object keys.      */
specifier|public
name|java
operator|.
name|util
operator|.
name|Map
name|getObjectKeys
parameter_list|()
block|{
return|return
name|objectKeys
return|;
block|}
comment|/**      * This will get the output stream.      *      * @return The output stream.      */
specifier|protected
name|java
operator|.
name|io
operator|.
name|OutputStream
name|getOutput
parameter_list|()
block|{
return|return
name|output
return|;
block|}
comment|/**      * This will get the standard output stream.      *      * @return The standard output stream.      */
specifier|protected
name|COSStandardOutputStream
name|getStandardOutput
parameter_list|()
block|{
return|return
name|standardOutput
return|;
block|}
comment|/**      * This will get the current start xref.      *      * @return The current start xref.      */
specifier|protected
name|long
name|getStartxref
parameter_list|()
block|{
return|return
name|startxref
return|;
block|}
comment|/**      * This will get the xref entries.      *      * @return All available xref entries.      */
specifier|protected
name|java
operator|.
name|util
operator|.
name|List
name|getXRefEntries
parameter_list|()
block|{
return|return
name|xRefEntries
return|;
block|}
comment|/**      * This will set the current object number.      *      * @param newNumber The new object number.      */
specifier|protected
name|void
name|setNumber
parameter_list|(
name|long
name|newNumber
parameter_list|)
block|{
name|number
operator|=
name|newNumber
expr_stmt|;
block|}
comment|/**      * This will set the output stream.      *      * @param newOutput The new output stream.      */
specifier|private
name|void
name|setOutput
parameter_list|(
name|OutputStream
name|newOutput
parameter_list|)
block|{
name|output
operator|=
name|newOutput
expr_stmt|;
block|}
comment|/**      * This will set the standard output stream.      *      * @param newStandardOutput The new standard output stream.      */
specifier|private
name|void
name|setStandardOutput
parameter_list|(
name|COSStandardOutputStream
name|newStandardOutput
parameter_list|)
block|{
name|standardOutput
operator|=
name|newStandardOutput
expr_stmt|;
block|}
comment|/**      * This will set the start xref.      *      * @param newStartxref The new start xref attribute.      */
specifier|protected
name|void
name|setStartxref
parameter_list|(
name|long
name|newStartxref
parameter_list|)
block|{
name|startxref
operator|=
name|newStartxref
expr_stmt|;
block|}
comment|/**      * This will write the body of the document.      *      * @param doc The document to write the body for.      *      * @throws IOException If there is an error writing the data.      * @throws COSVisitorException If there is an error generating the data.      */
specifier|protected
name|void
name|doWriteBody
parameter_list|(
name|COSDocument
name|doc
parameter_list|)
throws|throws
name|IOException
throws|,
name|COSVisitorException
block|{
name|COSDictionary
name|trailer
init|=
name|doc
operator|.
name|getTrailer
argument_list|()
decl_stmt|;
name|COSDictionary
name|root
init|=
operator|(
name|COSDictionary
operator|)
name|trailer
operator|.
name|getDictionaryObject
argument_list|(
name|COSName
operator|.
name|ROOT
argument_list|)
decl_stmt|;
name|COSDictionary
name|info
init|=
operator|(
name|COSDictionary
operator|)
name|trailer
operator|.
name|getDictionaryObject
argument_list|(
name|COSName
operator|.
name|getPDFName
argument_list|(
literal|"Info"
argument_list|)
argument_list|)
decl_stmt|;
name|COSDictionary
name|encrypt
init|=
operator|(
name|COSDictionary
operator|)
name|trailer
operator|.
name|getDictionaryObject
argument_list|(
name|COSName
operator|.
name|getPDFName
argument_list|(
literal|"Encrypt"
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|root
operator|!=
literal|null
condition|)
block|{
name|addObjectToWrite
argument_list|(
name|root
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|info
operator|!=
literal|null
condition|)
block|{
name|addObjectToWrite
argument_list|(
name|info
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|objectsToWrite
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|COSBase
name|nextObject
init|=
operator|(
name|COSBase
operator|)
name|objectsToWrite
operator|.
name|remove
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|doWriteObject
argument_list|(
name|nextObject
argument_list|)
expr_stmt|;
block|}
name|willEncrypt
operator|=
literal|false
expr_stmt|;
if|if
condition|(
name|encrypt
operator|!=
literal|null
condition|)
block|{
name|addObjectToWrite
argument_list|(
name|encrypt
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|objectsToWrite
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|COSBase
name|nextObject
init|=
operator|(
name|COSBase
operator|)
name|objectsToWrite
operator|.
name|remove
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|doWriteObject
argument_list|(
name|nextObject
argument_list|)
expr_stmt|;
block|}
comment|// write all objects
comment|/**         for (Iterator i = doc.getObjects().iterator(); i.hasNext();)         {             COSObject obj = (COSObject) i.next();             doWriteObject(obj);         }**/
block|}
specifier|private
name|void
name|addObjectToWrite
parameter_list|(
name|COSBase
name|object
parameter_list|)
block|{
name|COSBase
name|actual
init|=
name|object
decl_stmt|;
if|if
condition|(
name|actual
operator|instanceof
name|COSObject
condition|)
block|{
name|actual
operator|=
operator|(
operator|(
name|COSObject
operator|)
name|actual
operator|)
operator|.
name|getObject
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|writtenObjects
operator|.
name|contains
argument_list|(
name|object
argument_list|)
operator|&&
operator|!
name|objectsToWrite
operator|.
name|contains
argument_list|(
name|object
argument_list|)
operator|&&
operator|!
name|actualsAdded
operator|.
name|contains
argument_list|(
name|actual
argument_list|)
condition|)
block|{
name|objectsToWrite
operator|.
name|add
argument_list|(
name|object
argument_list|)
expr_stmt|;
if|if
condition|(
name|actual
operator|!=
literal|null
condition|)
block|{
name|actualsAdded
operator|.
name|add
argument_list|(
name|actual
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**      * This will write a COS object.      *      * @param obj The object to write.      *      * @throws COSVisitorException If there is an error visiting objects.      */
specifier|public
name|void
name|doWriteObject
parameter_list|(
name|COSBase
name|obj
parameter_list|)
throws|throws
name|COSVisitorException
block|{
try|try
block|{
name|writtenObjects
operator|.
name|add
argument_list|(
name|obj
argument_list|)
expr_stmt|;
comment|// find the physical reference
name|currentObjectKey
operator|=
name|getObjectKey
argument_list|(
name|obj
argument_list|)
expr_stmt|;
comment|// add a x ref entry
name|addXRefEntry
argument_list|(
operator|new
name|COSWriterXRefEntry
argument_list|(
name|getStandardOutput
argument_list|()
operator|.
name|getPos
argument_list|()
argument_list|,
name|obj
argument_list|,
name|currentObjectKey
argument_list|)
argument_list|)
expr_stmt|;
comment|// write the object
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|String
operator|.
name|valueOf
argument_list|(
name|currentObjectKey
operator|.
name|getNumber
argument_list|()
argument_list|)
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|SPACE
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|String
operator|.
name|valueOf
argument_list|(
name|currentObjectKey
operator|.
name|getGeneration
argument_list|()
argument_list|)
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|SPACE
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|OBJ
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeEOL
argument_list|()
expr_stmt|;
name|obj
operator|.
name|accept
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeEOL
argument_list|()
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|ENDOBJ
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeEOL
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|COSVisitorException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**      * This will write the header to the PDF document.      *      * @param doc The document to get the data from.      *      * @throws IOException If there is an error writing to the stream.      */
specifier|protected
name|void
name|doWriteHeader
parameter_list|(
name|COSDocument
name|doc
parameter_list|)
throws|throws
name|IOException
block|{
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|doc
operator|.
name|getHeaderString
argument_list|()
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeEOL
argument_list|()
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|COMMENT
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|GARBAGE
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeEOL
argument_list|()
expr_stmt|;
block|}
comment|/**      * This will write the trailer to the PDF document.      *      * @param doc The document to create the trailer for.      *      * @throws IOException If there is an IOError while writing the document.      * @throws COSVisitorException If there is an error while generating the data.      */
specifier|protected
name|void
name|doWriteTrailer
parameter_list|(
name|COSDocument
name|doc
parameter_list|)
throws|throws
name|IOException
throws|,
name|COSVisitorException
block|{
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|TRAILER
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeEOL
argument_list|()
expr_stmt|;
name|COSDictionary
name|trailer
init|=
name|doc
operator|.
name|getTrailer
argument_list|()
decl_stmt|;
comment|//sort xref, needed only if object keys not regenerated
name|Collections
operator|.
name|sort
argument_list|(
name|getXRefEntries
argument_list|()
argument_list|)
expr_stmt|;
name|COSWriterXRefEntry
name|lastEntry
init|=
operator|(
name|COSWriterXRefEntry
operator|)
name|getXRefEntries
argument_list|()
operator|.
name|get
argument_list|(
name|getXRefEntries
argument_list|()
operator|.
name|size
argument_list|()
operator|-
literal|1
argument_list|)
decl_stmt|;
name|trailer
operator|.
name|setInt
argument_list|(
name|COSName
operator|.
name|getPDFName
argument_list|(
literal|"Size"
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|lastEntry
operator|.
name|getKey
argument_list|()
operator|.
name|getNumber
argument_list|()
operator|+
literal|1
argument_list|)
expr_stmt|;
name|trailer
operator|.
name|removeItem
argument_list|(
name|COSName
operator|.
name|PREV
argument_list|)
expr_stmt|;
comment|/**         COSObject catalog = doc.getCatalog();         if (catalog != null)         {             trailer.setItem(COSName.getPDFName("Root"), catalog);         }         */
name|trailer
operator|.
name|accept
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|STARTXREF
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeEOL
argument_list|()
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|String
operator|.
name|valueOf
argument_list|(
name|getStartxref
argument_list|()
argument_list|)
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeEOL
argument_list|()
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|EOF
argument_list|)
expr_stmt|;
block|}
comment|/**      * write the x ref section for the pdf file      *      * currently, the pdf is reconstructed from the scratch, so we write a single section      *      * todo support for incremental writing?      *      * @param doc The document to write the xref from.      *      * @throws IOException If there is an error writing the data to the stream.      */
specifier|protected
name|void
name|doWriteXRef
parameter_list|(
name|COSDocument
name|doc
parameter_list|)
throws|throws
name|IOException
block|{
name|String
name|offset
decl_stmt|;
name|String
name|generation
decl_stmt|;
comment|// sort xref, needed only if object keys not regenerated
name|Collections
operator|.
name|sort
argument_list|(
name|getXRefEntries
argument_list|()
argument_list|)
expr_stmt|;
name|COSWriterXRefEntry
name|lastEntry
init|=
operator|(
name|COSWriterXRefEntry
operator|)
name|getXRefEntries
argument_list|()
operator|.
name|get
argument_list|(
name|getXRefEntries
argument_list|()
operator|.
name|size
argument_list|()
operator|-
literal|1
argument_list|)
decl_stmt|;
comment|// remember the position where x ref is written
name|setStartxref
argument_list|(
name|getStandardOutput
argument_list|()
operator|.
name|getPos
argument_list|()
argument_list|)
expr_stmt|;
comment|//
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|XREF
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeEOL
argument_list|()
expr_stmt|;
comment|// write start object number and object count for this x ref section
comment|// we assume starting from scratch
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|String
operator|.
name|valueOf
argument_list|(
literal|0
argument_list|)
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|SPACE
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|String
operator|.
name|valueOf
argument_list|(
name|lastEntry
operator|.
name|getKey
argument_list|()
operator|.
name|getNumber
argument_list|()
operator|+
literal|1
argument_list|)
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeEOL
argument_list|()
expr_stmt|;
comment|// write initial start object with ref to first deleted object and magic generation number
name|offset
operator|=
name|formatXrefOffset
operator|.
name|format
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|generation
operator|=
name|formatXrefGeneration
operator|.
name|format
argument_list|(
literal|65535
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|offset
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|SPACE
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|generation
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|SPACE
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|XREF_FREE
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeCRLF
argument_list|()
expr_stmt|;
comment|// write entry for every object
name|long
name|lastObjectNumber
init|=
literal|0
decl_stmt|;
for|for
control|(
name|Iterator
name|i
init|=
name|getXRefEntries
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|i
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|COSWriterXRefEntry
name|entry
init|=
operator|(
name|COSWriterXRefEntry
operator|)
name|i
operator|.
name|next
argument_list|()
decl_stmt|;
while|while
condition|(
name|lastObjectNumber
operator|<
name|entry
operator|.
name|getKey
argument_list|()
operator|.
name|getNumber
argument_list|()
operator|-
literal|1
condition|)
block|{
name|offset
operator|=
name|formatXrefOffset
operator|.
name|format
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|generation
operator|=
name|formatXrefGeneration
operator|.
name|format
argument_list|(
literal|65535
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|offset
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|SPACE
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|generation
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|SPACE
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|XREF_FREE
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeCRLF
argument_list|()
expr_stmt|;
name|lastObjectNumber
operator|++
expr_stmt|;
block|}
name|lastObjectNumber
operator|=
name|entry
operator|.
name|getKey
argument_list|()
operator|.
name|getNumber
argument_list|()
expr_stmt|;
name|offset
operator|=
name|formatXrefOffset
operator|.
name|format
argument_list|(
name|entry
operator|.
name|getOffset
argument_list|()
argument_list|)
expr_stmt|;
name|generation
operator|=
name|formatXrefGeneration
operator|.
name|format
argument_list|(
name|entry
operator|.
name|getKey
argument_list|()
operator|.
name|getGeneration
argument_list|()
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|offset
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|SPACE
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|generation
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|SPACE
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|entry
operator|.
name|isFree
argument_list|()
condition|?
name|XREF_FREE
else|:
name|XREF_USED
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeCRLF
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**      * This will get the object key for the object.      *      * @param obj The object to get the key for.      *      * @return The object key for the object.      */
specifier|private
name|COSObjectKey
name|getObjectKey
parameter_list|(
name|COSBase
name|obj
parameter_list|)
block|{
name|COSBase
name|actual
init|=
name|obj
decl_stmt|;
if|if
condition|(
name|actual
operator|instanceof
name|COSObject
condition|)
block|{
name|actual
operator|=
operator|(
operator|(
name|COSObject
operator|)
name|obj
operator|)
operator|.
name|getObject
argument_list|()
expr_stmt|;
block|}
name|COSObjectKey
name|key
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|actual
operator|!=
literal|null
condition|)
block|{
name|key
operator|=
operator|(
name|COSObjectKey
operator|)
name|objectKeys
operator|.
name|get
argument_list|(
name|actual
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|key
operator|==
literal|null
condition|)
block|{
name|key
operator|=
operator|(
name|COSObjectKey
operator|)
name|objectKeys
operator|.
name|get
argument_list|(
name|obj
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|key
operator|==
literal|null
condition|)
block|{
name|setNumber
argument_list|(
name|getNumber
argument_list|()
operator|+
literal|1
argument_list|)
expr_stmt|;
name|key
operator|=
operator|new
name|COSObjectKey
argument_list|(
name|getNumber
argument_list|()
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|objectKeys
operator|.
name|put
argument_list|(
name|obj
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|actual
operator|!=
literal|null
condition|)
block|{
name|objectKeys
operator|.
name|put
argument_list|(
name|actual
argument_list|,
name|key
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|key
return|;
block|}
comment|/**      * visitFromArray method comment.      *      * @param obj The object that is being visited.      *      * @throws COSVisitorException If there is an exception while visiting this object.      *      * @return null      */
specifier|public
name|Object
name|visitFromArray
parameter_list|(
name|COSArray
name|obj
parameter_list|)
throws|throws
name|COSVisitorException
block|{
try|try
block|{
name|int
name|count
init|=
literal|0
decl_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|ARRAY_OPEN
argument_list|)
expr_stmt|;
for|for
control|(
name|Iterator
name|i
init|=
name|obj
operator|.
name|iterator
argument_list|()
init|;
name|i
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|COSBase
name|current
init|=
operator|(
name|COSBase
operator|)
name|i
operator|.
name|next
argument_list|()
decl_stmt|;
if|if
condition|(
name|current
operator|instanceof
name|COSDictionary
condition|)
block|{
name|addObjectToWrite
argument_list|(
name|current
argument_list|)
expr_stmt|;
name|writeReference
argument_list|(
name|current
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|current
operator|instanceof
name|COSObject
condition|)
block|{
name|COSBase
name|subValue
init|=
operator|(
operator|(
name|COSObject
operator|)
name|current
operator|)
operator|.
name|getObject
argument_list|()
decl_stmt|;
if|if
condition|(
name|subValue
operator|instanceof
name|COSDictionary
operator|||
name|subValue
operator|==
literal|null
condition|)
block|{
name|addObjectToWrite
argument_list|(
name|current
argument_list|)
expr_stmt|;
name|writeReference
argument_list|(
name|current
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|subValue
operator|.
name|accept
argument_list|(
name|this
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|current
operator|==
literal|null
condition|)
block|{
name|COSNull
operator|.
name|NULL
operator|.
name|accept
argument_list|(
name|this
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|current
operator|.
name|accept
argument_list|(
name|this
argument_list|)
expr_stmt|;
block|}
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|.
name|hasNext
argument_list|()
condition|)
block|{
if|if
condition|(
name|count
operator|%
literal|10
operator|==
literal|0
condition|)
block|{
name|getStandardOutput
argument_list|()
operator|.
name|writeEOL
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|SPACE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|ARRAY_CLOSE
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeEOL
argument_list|()
expr_stmt|;
return|return
literal|null
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|COSVisitorException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**      * visitFromBoolean method comment.      *      * @param obj The object that is being visited.      *      * @throws COSVisitorException If there is an exception while visiting this object.      *      * @return null      */
specifier|public
name|Object
name|visitFromBoolean
parameter_list|(
name|COSBoolean
name|obj
parameter_list|)
throws|throws
name|COSVisitorException
block|{
try|try
block|{
name|obj
operator|.
name|writePDF
argument_list|(
name|getStandardOutput
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|COSVisitorException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**      * visitFromDictionary method comment.      *      * @param obj The object that is being visited.      *      * @throws COSVisitorException If there is an exception while visiting this object.      *      * @return null      */
specifier|public
name|Object
name|visitFromDictionary
parameter_list|(
name|COSDictionary
name|obj
parameter_list|)
throws|throws
name|COSVisitorException
block|{
try|try
block|{
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|DICT_OPEN
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeEOL
argument_list|()
expr_stmt|;
for|for
control|(
name|Iterator
name|i
init|=
name|obj
operator|.
name|keyList
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|i
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|COSName
name|name
init|=
operator|(
name|COSName
operator|)
name|i
operator|.
name|next
argument_list|()
decl_stmt|;
name|COSBase
name|value
init|=
name|obj
operator|.
name|getItem
argument_list|(
name|name
argument_list|)
decl_stmt|;
if|if
condition|(
name|value
operator|!=
literal|null
condition|)
block|{
name|name
operator|.
name|accept
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|SPACE
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|instanceof
name|COSDictionary
condition|)
block|{
name|addObjectToWrite
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|writeReference
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|value
operator|instanceof
name|COSObject
condition|)
block|{
name|COSBase
name|subValue
init|=
operator|(
operator|(
name|COSObject
operator|)
name|value
operator|)
operator|.
name|getObject
argument_list|()
decl_stmt|;
if|if
condition|(
name|subValue
operator|instanceof
name|COSDictionary
operator|||
name|subValue
operator|==
literal|null
condition|)
block|{
name|addObjectToWrite
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|writeReference
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|subValue
operator|.
name|accept
argument_list|(
name|this
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|value
operator|.
name|accept
argument_list|(
name|this
argument_list|)
expr_stmt|;
block|}
name|getStandardOutput
argument_list|()
operator|.
name|writeEOL
argument_list|()
expr_stmt|;
block|}
else|else
block|{
comment|//then we won't write anything, there are a couple cases
comment|//were the value of an entry in the COSDictionary will
comment|//be a dangling reference that points to nothing
comment|//so we will just not write out the entry if that is the case
block|}
block|}
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|DICT_CLOSE
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeEOL
argument_list|()
expr_stmt|;
return|return
literal|null
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|COSVisitorException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**      * The visit from document method.      *      * @param doc The object that is being visited.      *      * @throws COSVisitorException If there is an exception while visiting this object.      *      * @return null      */
specifier|public
name|Object
name|visitFromDocument
parameter_list|(
name|COSDocument
name|doc
parameter_list|)
throws|throws
name|COSVisitorException
block|{
try|try
block|{
name|doWriteHeader
argument_list|(
name|doc
argument_list|)
expr_stmt|;
name|doWriteBody
argument_list|(
name|doc
argument_list|)
expr_stmt|;
name|doWriteXRef
argument_list|(
name|doc
argument_list|)
expr_stmt|;
name|doWriteTrailer
argument_list|(
name|doc
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|COSVisitorException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**      * visitFromFloat method comment.      *      * @param obj The object that is being visited.      *      * @throws COSVisitorException If there is an exception while visiting this object.      *      * @return null      */
specifier|public
name|Object
name|visitFromFloat
parameter_list|(
name|COSFloat
name|obj
parameter_list|)
throws|throws
name|COSVisitorException
block|{
try|try
block|{
name|obj
operator|.
name|writePDF
argument_list|(
name|getStandardOutput
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|COSVisitorException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**      * visitFromFloat method comment.      *      * @param obj The object that is being visited.      *      * @throws COSVisitorException If there is an exception while visiting this object.      *      * @return null      */
specifier|public
name|Object
name|visitFromInt
parameter_list|(
name|COSInteger
name|obj
parameter_list|)
throws|throws
name|COSVisitorException
block|{
try|try
block|{
name|obj
operator|.
name|writePDF
argument_list|(
name|getStandardOutput
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|COSVisitorException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**      * visitFromName method comment.      *      * @param obj The object that is being visited.      *      * @throws COSVisitorException If there is an exception while visiting this object.      *      * @return null      */
specifier|public
name|Object
name|visitFromName
parameter_list|(
name|COSName
name|obj
parameter_list|)
throws|throws
name|COSVisitorException
block|{
try|try
block|{
name|obj
operator|.
name|writePDF
argument_list|(
name|getStandardOutput
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|COSVisitorException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**      * visitFromNull method comment.      *      * @param obj The object that is being visited.      *      * @throws COSVisitorException If there is an exception while visiting this object.      *      * @return null      */
specifier|public
name|Object
name|visitFromNull
parameter_list|(
name|COSNull
name|obj
parameter_list|)
throws|throws
name|COSVisitorException
block|{
try|try
block|{
name|obj
operator|.
name|writePDF
argument_list|(
name|getStandardOutput
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|COSVisitorException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**      * visitFromObjRef method comment.      *      * @param obj The object that is being visited.      *      * @throws COSVisitorException If there is an exception while visiting this object.      */
specifier|public
name|void
name|writeReference
parameter_list|(
name|COSBase
name|obj
parameter_list|)
throws|throws
name|COSVisitorException
block|{
try|try
block|{
name|COSObjectKey
name|key
init|=
name|getObjectKey
argument_list|(
name|obj
argument_list|)
decl_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|String
operator|.
name|valueOf
argument_list|(
name|key
operator|.
name|getNumber
argument_list|()
argument_list|)
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|SPACE
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|String
operator|.
name|valueOf
argument_list|(
name|key
operator|.
name|getGeneration
argument_list|()
argument_list|)
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|SPACE
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|REFERENCE
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|COSVisitorException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**      * visitFromStream method comment.      *      * @param obj The object that is being visited.      *      * @throws COSVisitorException If there is an exception while visiting this object.      *      * @return null      */
specifier|public
name|Object
name|visitFromStream
parameter_list|(
name|COSStream
name|obj
parameter_list|)
throws|throws
name|COSVisitorException
block|{
try|try
block|{
if|if
condition|(
name|willEncrypt
condition|)
block|{
name|document
operator|.
name|getSecurityHandler
argument_list|()
operator|.
name|decryptStream
argument_list|(
name|obj
argument_list|,
name|currentObjectKey
operator|.
name|getNumber
argument_list|()
argument_list|,
name|currentObjectKey
operator|.
name|getGeneration
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|InputStream
name|input
init|=
name|obj
operator|.
name|getFilteredStream
argument_list|()
decl_stmt|;
comment|// set the length of the stream and write stream dictionary
name|COSObject
name|lengthObject
init|=
operator|new
name|COSObject
argument_list|(
literal|null
argument_list|)
decl_stmt|;
name|obj
operator|.
name|setItem
argument_list|(
name|COSName
operator|.
name|LENGTH
argument_list|,
name|lengthObject
argument_list|)
expr_stmt|;
comment|//obj.accept(this);
comment|// write the stream content
name|visitFromDictionary
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|STREAM
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeCRLF
argument_list|()
expr_stmt|;
name|byte
index|[]
name|buffer
init|=
operator|new
name|byte
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|amountRead
init|=
literal|0
decl_stmt|;
name|int
name|totalAmountWritten
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|(
name|amountRead
operator|=
name|input
operator|.
name|read
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
literal|1024
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|amountRead
argument_list|)
expr_stmt|;
name|totalAmountWritten
operator|+=
name|amountRead
expr_stmt|;
block|}
name|lengthObject
operator|.
name|setObject
argument_list|(
operator|new
name|COSInteger
argument_list|(
name|totalAmountWritten
argument_list|)
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeCRLF
argument_list|()
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|write
argument_list|(
name|ENDSTREAM
argument_list|)
expr_stmt|;
name|getStandardOutput
argument_list|()
operator|.
name|writeEOL
argument_list|()
expr_stmt|;
return|return
literal|null
return|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|COSVisitorException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
comment|/**      * visitFromString method comment.      *      * @param obj The object that is being visited.      *      * @return null      *      * @throws COSVisitorException If there is an exception while visiting this object.      */
specifier|public
name|Object
name|visitFromString
parameter_list|(
name|COSString
name|obj
parameter_list|)
throws|throws
name|COSVisitorException
block|{
try|try
block|{
if|if
condition|(
name|willEncrypt
condition|)
block|{
name|document
operator|.
name|getSecurityHandler
argument_list|()
operator|.
name|decryptString
argument_list|(
name|obj
argument_list|,
name|currentObjectKey
operator|.
name|getNumber
argument_list|()
argument_list|,
name|currentObjectKey
operator|.
name|getGeneration
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|obj
operator|.
name|writePDF
argument_list|(
name|getStandardOutput
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|COSVisitorException
argument_list|(
name|e
argument_list|)
throw|;
block|}
return|return
literal|null
return|;
block|}
comment|/**      * This will write the pdf document.      *      * @param doc The document to write.      *      * @throws COSVisitorException If an error occurs while generating the data.      */
specifier|public
name|void
name|write
parameter_list|(
name|COSDocument
name|doc
parameter_list|)
throws|throws
name|COSVisitorException
block|{
name|PDDocument
name|pdDoc
init|=
operator|new
name|PDDocument
argument_list|(
name|doc
argument_list|)
decl_stmt|;
name|write
argument_list|(
name|pdDoc
argument_list|)
expr_stmt|;
block|}
comment|/**      * This will write the pdf document.      *      * @param doc The document to write.      *      * @throws COSVisitorException If an error occurs while generating the data.      */
specifier|public
name|void
name|write
parameter_list|(
name|PDDocument
name|doc
parameter_list|)
throws|throws
name|COSVisitorException
block|{
name|document
operator|=
name|doc
expr_stmt|;
name|SecurityHandler
name|securityHandler
init|=
name|document
operator|.
name|getSecurityHandler
argument_list|()
decl_stmt|;
if|if
condition|(
name|securityHandler
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|securityHandler
operator|.
name|prepareDocumentForEncryption
argument_list|(
name|document
argument_list|)
expr_stmt|;
name|this
operator|.
name|willEncrypt
operator|=
literal|true
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|COSVisitorException
argument_list|(
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|CryptographyException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|COSVisitorException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
else|else
block|{
name|this
operator|.
name|willEncrypt
operator|=
literal|false
expr_stmt|;
block|}
name|COSDocument
name|cosDoc
init|=
name|document
operator|.
name|getDocument
argument_list|()
decl_stmt|;
name|COSDictionary
name|trailer
init|=
name|cosDoc
operator|.
name|getTrailer
argument_list|()
decl_stmt|;
name|COSArray
name|idArray
init|=
operator|(
name|COSArray
operator|)
name|trailer
operator|.
name|getDictionaryObject
argument_list|(
literal|"ID"
argument_list|)
decl_stmt|;
if|if
condition|(
name|idArray
operator|==
literal|null
condition|)
block|{
try|try
block|{
comment|//algothim says to use time/path/size/values in doc to generate
comment|//the id.  We don't have path or size, so do the best we can
name|MessageDigest
name|md
init|=
name|MessageDigest
operator|.
name|getInstance
argument_list|(
literal|"MD5"
argument_list|)
decl_stmt|;
name|md
operator|.
name|update
argument_list|(
name|Long
operator|.
name|toString
argument_list|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
argument_list|)
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
name|COSDictionary
name|info
init|=
operator|(
name|COSDictionary
operator|)
name|trailer
operator|.
name|getDictionaryObject
argument_list|(
literal|"Info"
argument_list|)
decl_stmt|;
if|if
condition|(
name|info
operator|!=
literal|null
condition|)
block|{
name|Iterator
name|values
init|=
name|info
operator|.
name|getValues
argument_list|()
operator|.
name|iterator
argument_list|()
decl_stmt|;
while|while
condition|(
name|values
operator|.
name|hasNext
argument_list|()
condition|)
block|{
name|md
operator|.
name|update
argument_list|(
name|values
operator|.
name|next
argument_list|()
operator|.
name|toString
argument_list|()
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
name|idArray
operator|=
operator|new
name|COSArray
argument_list|()
expr_stmt|;
name|COSString
name|id
init|=
operator|new
name|COSString
argument_list|(
name|md
operator|.
name|digest
argument_list|()
argument_list|)
decl_stmt|;
name|idArray
operator|.
name|add
argument_list|(
name|id
argument_list|)
expr_stmt|;
name|idArray
operator|.
name|add
argument_list|(
name|id
argument_list|)
expr_stmt|;
name|trailer
operator|.
name|setItem
argument_list|(
literal|"ID"
argument_list|,
name|idArray
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NoSuchAlgorithmException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|COSVisitorException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
comment|/*         List objects = doc.getObjects();         Iterator iter = objects.iterator();         long maxNumber = 0;         while( iter.hasNext() )         {             COSObject object = (COSObject)iter.next();             if( object.getObjectNumber() != null&&                 object.getGenerationNumber() != null )             {                 COSObjectKey key = new COSObjectKey( object.getObjectNumber().longValue(),                                                      object.getGenerationNumber().longValue() );                 objectKeys.put( object.getObject(), key );                 objectKeys.put( object, key );                 maxNumber = Math.max( key.getNumber(), maxNumber );                 setNumber( maxNumber );             }         }*/
name|cosDoc
operator|.
name|accept
argument_list|(
name|this
argument_list|)
expr_stmt|;
block|}
block|}
end_class

end_unit

