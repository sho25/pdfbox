begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|pdmodel
operator|.
name|font
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|fontbox
operator|.
name|util
operator|.
name|BoundingBox
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|COSArray
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|COSBase
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|COSDictionary
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|COSName
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|cos
operator|.
name|COSNumber
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|pdmodel
operator|.
name|common
operator|.
name|COSObjectable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|util
operator|.
name|Matrix
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|pdfbox
operator|.
name|util
operator|.
name|Vector
import|;
end_import

begin_comment
comment|/**  * A CIDFont. A CIDFont is a PDF object that contains information about a CIDFont program. Although  * its Type value is Font, a CIDFont is not actually a font.  *  *<p>It is not usually necessary to use this class directly, prefer {@link PDType0Font}.  *  * @author Ben Litchfield  */
end_comment

begin_class
specifier|public
specifier|abstract
class|class
name|PDCIDFont
implements|implements
name|COSObjectable
implements|,
name|PDFontLike
block|{
specifier|protected
specifier|final
name|PDType0Font
name|parent
decl_stmt|;
specifier|private
name|Map
argument_list|<
name|Integer
argument_list|,
name|Float
argument_list|>
name|widths
decl_stmt|;
specifier|private
name|float
name|defaultWidth
decl_stmt|;
specifier|private
specifier|final
name|Map
argument_list|<
name|Integer
argument_list|,
name|Float
argument_list|>
name|verticalDisplacementY
init|=
operator|new
name|HashMap
argument_list|<
name|Integer
argument_list|,
name|Float
argument_list|>
argument_list|()
decl_stmt|;
comment|// w1y
specifier|private
specifier|final
name|Map
argument_list|<
name|Integer
argument_list|,
name|Vector
argument_list|>
name|positionVectors
init|=
operator|new
name|HashMap
argument_list|<
name|Integer
argument_list|,
name|Vector
argument_list|>
argument_list|()
decl_stmt|;
comment|// v
specifier|private
name|float
index|[]
name|dw2
decl_stmt|;
specifier|protected
specifier|final
name|COSDictionary
name|dict
decl_stmt|;
specifier|private
name|PDFontDescriptor
name|fontDescriptor
decl_stmt|;
comment|/**      * Constructor.      *      * @param fontDictionary The font dictionary according to the PDF specification.      */
name|PDCIDFont
parameter_list|(
name|COSDictionary
name|fontDictionary
parameter_list|,
name|PDType0Font
name|parent
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|dict
operator|=
name|fontDictionary
expr_stmt|;
name|this
operator|.
name|parent
operator|=
name|parent
expr_stmt|;
name|readWidths
argument_list|()
expr_stmt|;
name|readVerticalDisplacements
argument_list|()
expr_stmt|;
block|}
specifier|private
name|void
name|readWidths
parameter_list|()
block|{
name|widths
operator|=
operator|new
name|HashMap
argument_list|<
name|Integer
argument_list|,
name|Float
argument_list|>
argument_list|()
expr_stmt|;
name|COSArray
name|widths
init|=
operator|(
name|COSArray
operator|)
name|dict
operator|.
name|getDictionaryObject
argument_list|(
name|COSName
operator|.
name|W
argument_list|)
decl_stmt|;
if|if
condition|(
name|widths
operator|!=
literal|null
condition|)
block|{
name|int
name|size
init|=
name|widths
operator|.
name|size
argument_list|()
decl_stmt|;
name|int
name|counter
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|counter
operator|<
name|size
condition|)
block|{
name|COSNumber
name|firstCode
init|=
operator|(
name|COSNumber
operator|)
name|widths
operator|.
name|getObject
argument_list|(
name|counter
operator|++
argument_list|)
decl_stmt|;
name|COSBase
name|next
init|=
name|widths
operator|.
name|getObject
argument_list|(
name|counter
operator|++
argument_list|)
decl_stmt|;
if|if
condition|(
name|next
operator|instanceof
name|COSArray
condition|)
block|{
name|COSArray
name|array
init|=
operator|(
name|COSArray
operator|)
name|next
decl_stmt|;
name|int
name|startRange
init|=
name|firstCode
operator|.
name|intValue
argument_list|()
decl_stmt|;
name|int
name|arraySize
init|=
name|array
operator|.
name|size
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|arraySize
condition|;
name|i
operator|++
control|)
block|{
name|COSNumber
name|width
init|=
operator|(
name|COSNumber
operator|)
name|array
operator|.
name|get
argument_list|(
name|i
argument_list|)
decl_stmt|;
name|this
operator|.
name|widths
operator|.
name|put
argument_list|(
name|startRange
operator|+
name|i
argument_list|,
name|width
operator|.
name|floatValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|COSNumber
name|secondCode
init|=
operator|(
name|COSNumber
operator|)
name|next
decl_stmt|;
name|COSNumber
name|rangeWidth
init|=
operator|(
name|COSNumber
operator|)
name|widths
operator|.
name|getObject
argument_list|(
name|counter
operator|++
argument_list|)
decl_stmt|;
name|int
name|startRange
init|=
name|firstCode
operator|.
name|intValue
argument_list|()
decl_stmt|;
name|int
name|endRange
init|=
name|secondCode
operator|.
name|intValue
argument_list|()
decl_stmt|;
name|float
name|width
init|=
name|rangeWidth
operator|.
name|floatValue
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
name|startRange
init|;
name|i
operator|<=
name|endRange
condition|;
name|i
operator|++
control|)
block|{
name|this
operator|.
name|widths
operator|.
name|put
argument_list|(
name|i
argument_list|,
name|width
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
specifier|private
name|void
name|readVerticalDisplacements
parameter_list|()
block|{
comment|// default position vector and vertical displacement vector
name|COSArray
name|cosDW2
init|=
operator|(
name|COSArray
operator|)
name|dict
operator|.
name|getDictionaryObject
argument_list|(
name|COSName
operator|.
name|DW2
argument_list|)
decl_stmt|;
if|if
condition|(
name|cosDW2
operator|!=
literal|null
condition|)
block|{
name|dw2
operator|=
operator|new
name|float
index|[
literal|2
index|]
expr_stmt|;
name|dw2
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|COSNumber
operator|)
name|cosDW2
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|)
operator|.
name|floatValue
argument_list|()
expr_stmt|;
name|dw2
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|COSNumber
operator|)
name|cosDW2
operator|.
name|get
argument_list|(
literal|1
argument_list|)
operator|)
operator|.
name|floatValue
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|dw2
operator|=
operator|new
name|float
index|[]
block|{
literal|880
block|,
operator|-
literal|1000
block|}
expr_stmt|;
block|}
comment|// vertical metrics for individual CIDs.
name|COSArray
name|w2
init|=
operator|(
name|COSArray
operator|)
name|dict
operator|.
name|getDictionaryObject
argument_list|(
name|COSName
operator|.
name|W2
argument_list|)
decl_stmt|;
if|if
condition|(
name|w2
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|w2
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|COSNumber
name|c
init|=
operator|(
name|COSNumber
operator|)
name|w2
operator|.
name|get
argument_list|(
name|i
argument_list|)
decl_stmt|;
name|COSBase
name|next
init|=
name|w2
operator|.
name|get
argument_list|(
operator|++
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|next
operator|instanceof
name|COSArray
condition|)
block|{
name|COSArray
name|array
init|=
operator|(
name|COSArray
operator|)
name|next
decl_stmt|;
for|for
control|(
name|int
name|j
init|=
literal|0
init|;
name|j
operator|<
name|array
operator|.
name|size
argument_list|()
condition|;
name|j
operator|++
control|)
block|{
name|int
name|cid
init|=
name|c
operator|.
name|intValue
argument_list|()
operator|+
name|j
decl_stmt|;
name|COSNumber
name|w1y
init|=
operator|(
name|COSNumber
operator|)
name|array
operator|.
name|get
argument_list|(
name|j
argument_list|)
decl_stmt|;
name|COSNumber
name|v1x
init|=
operator|(
name|COSNumber
operator|)
name|array
operator|.
name|get
argument_list|(
operator|++
name|j
argument_list|)
decl_stmt|;
name|COSNumber
name|v1y
init|=
operator|(
name|COSNumber
operator|)
name|array
operator|.
name|get
argument_list|(
operator|++
name|j
argument_list|)
decl_stmt|;
name|verticalDisplacementY
operator|.
name|put
argument_list|(
name|cid
argument_list|,
name|w1y
operator|.
name|floatValue
argument_list|()
argument_list|)
expr_stmt|;
name|positionVectors
operator|.
name|put
argument_list|(
name|cid
argument_list|,
operator|new
name|Vector
argument_list|(
name|v1x
operator|.
name|floatValue
argument_list|()
argument_list|,
name|v1y
operator|.
name|floatValue
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|int
name|first
init|=
name|c
operator|.
name|intValue
argument_list|()
decl_stmt|;
name|int
name|last
init|=
operator|(
operator|(
name|COSNumber
operator|)
name|next
operator|)
operator|.
name|intValue
argument_list|()
decl_stmt|;
name|COSNumber
name|w1y
init|=
operator|(
name|COSNumber
operator|)
name|w2
operator|.
name|get
argument_list|(
operator|++
name|i
argument_list|)
decl_stmt|;
name|COSNumber
name|v1x
init|=
operator|(
name|COSNumber
operator|)
name|w2
operator|.
name|get
argument_list|(
operator|++
name|i
argument_list|)
decl_stmt|;
name|COSNumber
name|v1y
init|=
operator|(
name|COSNumber
operator|)
name|w2
operator|.
name|get
argument_list|(
operator|++
name|i
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|cid
init|=
name|first
init|;
name|cid
operator|<=
name|last
condition|;
name|cid
operator|++
control|)
block|{
name|verticalDisplacementY
operator|.
name|put
argument_list|(
name|cid
argument_list|,
name|w1y
operator|.
name|floatValue
argument_list|()
argument_list|)
expr_stmt|;
name|positionVectors
operator|.
name|put
argument_list|(
name|cid
argument_list|,
operator|new
name|Vector
argument_list|(
name|v1x
operator|.
name|floatValue
argument_list|()
argument_list|,
name|v1y
operator|.
name|floatValue
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|COSDictionary
name|getCOSObject
parameter_list|()
block|{
return|return
name|dict
return|;
block|}
comment|/**      * The PostScript name of the font.      *      * @return The postscript name of the font.      */
specifier|public
name|String
name|getBaseFont
parameter_list|()
block|{
return|return
name|dict
operator|.
name|getNameAsString
argument_list|(
name|COSName
operator|.
name|BASE_FONT
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|String
name|getName
parameter_list|()
block|{
return|return
name|getBaseFont
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|PDFontDescriptor
name|getFontDescriptor
parameter_list|()
block|{
if|if
condition|(
name|fontDescriptor
operator|==
literal|null
condition|)
block|{
name|COSDictionary
name|fd
init|=
operator|(
name|COSDictionary
operator|)
name|dict
operator|.
name|getDictionaryObject
argument_list|(
name|COSName
operator|.
name|FONT_DESC
argument_list|)
decl_stmt|;
if|if
condition|(
name|fd
operator|!=
literal|null
condition|)
block|{
name|fontDescriptor
operator|=
operator|new
name|PDFontDescriptor
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|fontDescriptor
return|;
block|}
annotation|@
name|Override
specifier|public
specifier|abstract
name|Matrix
name|getFontMatrix
parameter_list|()
function_decl|;
comment|/**      * Returns the Type 0 font which is the parent of this font.      *      * @return parent Type 0 font      */
specifier|public
specifier|final
name|PDType0Font
name|getParent
parameter_list|()
block|{
return|return
name|parent
return|;
block|}
annotation|@
name|Override
specifier|public
specifier|abstract
name|BoundingBox
name|getBoundingBox
parameter_list|()
throws|throws
name|IOException
function_decl|;
comment|/**      * This will get the default width. The default value for the default width is 1000.      *      * @return The default width for the glyphs in this font.      */
specifier|private
name|float
name|getDefaultWidth
parameter_list|()
block|{
if|if
condition|(
name|defaultWidth
operator|==
literal|0
condition|)
block|{
name|COSNumber
name|number
init|=
operator|(
name|COSNumber
operator|)
name|dict
operator|.
name|getDictionaryObject
argument_list|(
name|COSName
operator|.
name|DW
argument_list|)
decl_stmt|;
if|if
condition|(
name|number
operator|!=
literal|null
condition|)
block|{
name|defaultWidth
operator|=
name|number
operator|.
name|floatValue
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|defaultWidth
operator|=
literal|1000
expr_stmt|;
block|}
block|}
return|return
name|defaultWidth
return|;
block|}
comment|/**      * Returns the default position vector (v).      *      * @param cid CID      */
specifier|private
name|Vector
name|getDefaultPositionVector
parameter_list|(
name|int
name|cid
parameter_list|)
block|{
name|float
name|w0
decl_stmt|;
if|if
condition|(
name|widths
operator|.
name|containsKey
argument_list|(
name|cid
argument_list|)
condition|)
block|{
name|Float
name|w
init|=
name|widths
operator|.
name|get
argument_list|(
name|cid
argument_list|)
decl_stmt|;
if|if
condition|(
name|w
operator|!=
literal|null
condition|)
block|{
name|w0
operator|=
name|w
expr_stmt|;
block|}
else|else
block|{
name|w0
operator|=
name|getDefaultWidth
argument_list|()
expr_stmt|;
block|}
block|}
else|else
block|{
name|w0
operator|=
name|getDefaultWidth
argument_list|()
expr_stmt|;
block|}
return|return
operator|new
name|Vector
argument_list|(
name|w0
operator|/
literal|2
argument_list|,
name|dw2
index|[
literal|0
index|]
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|Vector
name|getPositionVector
parameter_list|(
name|int
name|code
parameter_list|)
block|{
name|int
name|cid
init|=
name|codeToCID
argument_list|(
name|code
argument_list|)
decl_stmt|;
name|Vector
name|v
init|=
name|positionVectors
operator|.
name|get
argument_list|(
name|cid
argument_list|)
decl_stmt|;
if|if
condition|(
name|v
operator|!=
literal|null
condition|)
block|{
return|return
name|v
return|;
block|}
else|else
block|{
return|return
name|getDefaultPositionVector
argument_list|(
name|cid
argument_list|)
return|;
block|}
block|}
comment|/**      * Returns the y-component of the vertical displacement vector (w1).      *      * @param code character code      * @return w1y      */
specifier|public
name|float
name|getVerticalDisplacementVectorY
parameter_list|(
name|int
name|code
parameter_list|)
block|{
name|int
name|cid
init|=
name|codeToCID
argument_list|(
name|code
argument_list|)
decl_stmt|;
name|Float
name|w1y
init|=
name|verticalDisplacementY
operator|.
name|get
argument_list|(
name|cid
argument_list|)
decl_stmt|;
if|if
condition|(
name|w1y
operator|!=
literal|null
condition|)
block|{
return|return
name|w1y
return|;
block|}
else|else
block|{
return|return
name|dw2
index|[
literal|1
index|]
return|;
block|}
block|}
annotation|@
name|Override
specifier|public
specifier|abstract
name|float
name|getHeight
parameter_list|(
name|int
name|code
parameter_list|)
throws|throws
name|IOException
function_decl|;
annotation|@
name|Override
specifier|public
name|float
name|getWidth
parameter_list|(
name|int
name|code
parameter_list|)
throws|throws
name|IOException
block|{
comment|// these widths are supposed to be consistent with the actual widths given in the CIDFont
comment|// program, but PDFBOX-563 shows that when they are not, Acrobat overrides the embedded
comment|// font widths with the widths given in the font dictionary
name|int
name|cid
init|=
name|codeToCID
argument_list|(
name|code
argument_list|)
decl_stmt|;
if|if
condition|(
name|widths
operator|.
name|containsKey
argument_list|(
name|cid
argument_list|)
condition|)
block|{
name|Float
name|w
init|=
name|widths
operator|.
name|get
argument_list|(
name|cid
argument_list|)
decl_stmt|;
if|if
condition|(
name|w
operator|!=
literal|null
condition|)
block|{
return|return
name|w
return|;
block|}
else|else
block|{
return|return
name|getDefaultWidth
argument_list|()
return|;
block|}
block|}
else|else
block|{
return|return
name|getWidthFromFont
argument_list|(
name|code
argument_list|)
return|;
block|}
block|}
annotation|@
name|Override
specifier|public
specifier|abstract
name|float
name|getWidthFromFont
parameter_list|(
name|int
name|code
parameter_list|)
throws|throws
name|IOException
function_decl|;
annotation|@
name|Override
specifier|public
specifier|abstract
name|boolean
name|isEmbedded
parameter_list|()
function_decl|;
annotation|@
name|Override
comment|// todo: this method is highly suspicious, the average glyph width is not usually a good metric
specifier|public
name|float
name|getAverageFontWidth
parameter_list|()
block|{
name|float
name|totalWidths
init|=
literal|0.0f
decl_stmt|;
name|float
name|characterCount
init|=
literal|0.0f
decl_stmt|;
name|COSArray
name|widths
init|=
operator|(
name|COSArray
operator|)
name|dict
operator|.
name|getDictionaryObject
argument_list|(
name|COSName
operator|.
name|W
argument_list|)
decl_stmt|;
if|if
condition|(
name|widths
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|widths
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|COSNumber
name|firstCode
init|=
operator|(
name|COSNumber
operator|)
name|widths
operator|.
name|getObject
argument_list|(
name|i
operator|++
argument_list|)
decl_stmt|;
name|COSBase
name|next
init|=
name|widths
operator|.
name|getObject
argument_list|(
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|next
operator|instanceof
name|COSArray
condition|)
block|{
name|COSArray
name|array
init|=
operator|(
name|COSArray
operator|)
name|next
decl_stmt|;
for|for
control|(
name|int
name|j
init|=
literal|0
init|;
name|j
operator|<
name|array
operator|.
name|size
argument_list|()
condition|;
name|j
operator|++
control|)
block|{
name|COSNumber
name|width
init|=
operator|(
name|COSNumber
operator|)
name|array
operator|.
name|get
argument_list|(
name|j
argument_list|)
decl_stmt|;
name|totalWidths
operator|+=
name|width
operator|.
name|floatValue
argument_list|()
expr_stmt|;
name|characterCount
operator|+=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|i
operator|++
expr_stmt|;
name|COSNumber
name|rangeWidth
init|=
operator|(
name|COSNumber
operator|)
name|widths
operator|.
name|getObject
argument_list|(
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|rangeWidth
operator|.
name|floatValue
argument_list|()
operator|>
literal|0
condition|)
block|{
name|totalWidths
operator|+=
name|rangeWidth
operator|.
name|floatValue
argument_list|()
expr_stmt|;
name|characterCount
operator|+=
literal|1
expr_stmt|;
block|}
block|}
block|}
block|}
name|float
name|average
init|=
name|totalWidths
operator|/
name|characterCount
decl_stmt|;
if|if
condition|(
name|average
operator|<=
literal|0
condition|)
block|{
name|average
operator|=
name|getDefaultWidth
argument_list|()
expr_stmt|;
block|}
return|return
name|average
return|;
block|}
comment|/**      * Returns the CID for the given character code. If not found then CID 0 is returned.      *      * @param code character code      * @return CID      */
specifier|public
specifier|abstract
name|int
name|codeToCID
parameter_list|(
name|int
name|code
parameter_list|)
function_decl|;
comment|/**      * Returns the GID for the given character code.      *      * @param code character code      * @return GID      */
specifier|public
specifier|abstract
name|int
name|codeToGID
parameter_list|(
name|int
name|code
parameter_list|)
throws|throws
name|IOException
function_decl|;
comment|/**      * Encodes the given Unicode code point for use in a PDF content stream.      * Content streams use a multi-byte encoding with 1 to 4 bytes.      *      *<p>This method is called when embedding text in PDFs and when filling in fields.      *      * @param unicode Unicode code point.      * @return Array of 1 to 4 PDF content stream bytes.      * @throws IOException If the text could not be encoded.      */
specifier|protected
specifier|abstract
name|byte
index|[]
name|encode
parameter_list|(
name|int
name|unicode
parameter_list|)
throws|throws
name|IOException
function_decl|;
block|}
end_class

end_unit

